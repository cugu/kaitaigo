trigger:
- master

strategy:
  matrix:
    linux:
      imageName: ubuntu-16.04
    mac:
      imageName: macos-10.13
    windows:
      imageName: windows-2019

pool:
  vmImage: $(imageName)

variables:
  GO111MODULE: "on"

steps:
- script: |
    curl -sfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v1.18.0
    go mod download
    ./bin/golangci-lint run --enable-all -D lll --tests=false
  displayName: 'Lint'
  continueOnError: true
  condition: eq( variables['Agent.OS'], 'Linux' )

- script: |
    go test -v ./... -coverprofile=coverage.out
    go tool cover -html=coverage.out -o coverage.html
  displayName: 'Test'

- script: go build .
  displayName: 'Build'

- script: |
    ./kaitaigo `find ./tests -name "*.ksy" -type f | grep -v "/enum_fancy/"`
    make ks_tests
  displayName: 'Run kaitai test suite'
  continueOnError: true
